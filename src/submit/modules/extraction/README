# ExtractionModule v3.1 - –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è

## üìã –ß—Ç–æ –±—ã–ª–æ —É–ª—É—á—à–µ–Ω–æ

### 1. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –º–æ–¥–µ–ª–µ–π**
- –î–æ–±–∞–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—É—Ç—å –∫ models —á–µ—Ä–µ–∑ sys.path
- Fallback –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –º–æ–¥–µ–ª–∏ Message
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤

### 2. **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
- TTL –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–∫—Ç–æ–≤ (–∏–º—è - 24—á, –ª–æ–∫–∞—Ü–∏—è - 1—á –∏ —Ç.–¥.)
- –ö—ç—à –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ —Ñ–∞–∫—Ç–æ–≤ –¥–ª—è –∫—ç—à–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö

### 3. **–£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è**
- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è `info_updating` –≤–æ–ø—Ä–æ—Å–æ–≤
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–±—ã–ª ‚Üí —Å—Ç–∞–ª)
- –ñ–∏–∑–Ω–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–∂–µ–Ω–∏–ª—Å—è, –ø–µ—Ä–µ–µ—Ö–∞–ª, —Ä–æ–¥–∏–ª—Å—è —Ä–µ–±–µ–Ω–æ–∫)
- –°–æ—Å—Ç–∞–≤–Ω—ã–µ —Ñ–∞–∫—Ç—ã (–ø–æ–ª–Ω–æ–µ –∏–º—è, –∞–¥—Ä–µ—Å —Å —É–ª–∏—Ü–µ–π)
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã (—Å–µ–º–µ–π–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –Ω–∞–≤—ã–∫–∏)

### 4. **–ú–µ—Ç–æ–¥ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Ñ–∞–∫—Ç–∞–º**
```python
critical_facts = module.get_critical_facts(dialogue_id)
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {'name': '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä', 'age': '28', 'location': '–ú–æ—Å–∫–≤–∞', ...}
```

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –®–∞–≥ 1: –ó–∞–º–µ–Ω–∏—Ç–µ —Ñ–∞–π–ª—ã

```bash
# –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
cp src/submit/modules/extraction/module.py src/submit/modules/extraction/module.py.backup

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
cp improved_extraction_module.py src/submit/modules/extraction/module.py
cp fact_patterns_extended.py src/submit/modules/extraction/fact_patterns_extended.py
cp test_extraction_module.py tests/test_extraction_module.py
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç–µ __init__.py

```python
# src/submit/modules/extraction/__init__.py
from .fact_patterns_extended import (
    InfoUpdatePatterns,
    EnhancedFactPatterns,
    detect_question_type,
    create_enhanced_patterns
)

__all__.extend([
    'InfoUpdatePatterns',
    'EnhancedFactPatterns', 
    'detect_question_type',
    'create_enhanced_patterns'
])
```

### –®–∞–≥ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Orchestrator

```python
# –í orchestrator.py
extraction_module = ExtractionModule(config)

# –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ–≤ –≤ fallback
critical_facts = extraction_module.get_critical_facts(dialogue_id)
if critical_facts.get('name'):
    prompt = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–æ–≤—É—Ç {critical_facts['name']}"
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
python -m pytest tests/test_extraction_module.py -v
```

### –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```python
from modules.extraction.module import ExtractionModule

module = ExtractionModule({'use_rules': True})
result = module.extract_facts(
    "–ú–µ–Ω—è –∑–æ–≤—É—Ç –ò–≤–∞–Ω, –º–Ω–µ 30 –ª–µ—Ç", 
    {'session_id': '1', 'dialogue_id': '1'}
)
print(f"Extracted {len(result.data)} facts")

# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç—ã
critical = module.get_critical_facts('1')
print(f"Name: {critical.get('name')}, Age: {critical.get('age')}")
```

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ë–µ–Ω—á–º–∞—Ä–∫–∏
- **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤**: ~5-10ms
- **–ü–æ–ª—É—á–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ–≤**: ~1-2ms (–∏–∑ –∫—ç—à–∞)
- **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è**: ~20-30ms
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ info_updating**: ~10-15ms

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –ü—Ä–µ–¥–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Ä–æ–≤–Ω—è—Ö
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Ñ–∞–∫—Ç–∞–º

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```python
config = {
    'use_rules': True,          # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞
    'use_llm': False,           # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LLM (–ø–æ–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–æ)
    'min_confidence': 0.5,      # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
    'filter_copypaste': True,   # –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∫–æ–ø–∏–ø–∞—Å—Ç
    'max_text_length': 10000,   # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞
    'conflict_strategy': 'latest',  # –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    'rule_confidence_threshold': 0.7  # –ü–æ—Ä–æ–≥ –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
}
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏: 95%+ —Ç–æ—á–Ω–æ—Å—Ç—å
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞: 90%+ —Ç–æ—á–Ω–æ—Å—Ç—å
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: 85%+ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ
- ‚úÖ –°–∫–æ—Ä–æ—Å—Ç—å: <50ms –Ω–∞ –¥–∏–∞–ª–æ–≥
- ‚úÖ –ö—ç—à-—Ö–∏—Ç—ã: 60%+ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ß—Ç–æ —É–ª—É—á—à–µ–Ω–æ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞
1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Ñ–∞–∫—Ç–∞–º** (–∏–º—è, –≤–æ–∑—Ä–∞—Å—Ç, —Å—Ç–∞—Ç—É—Å)
2. **–ë—ã—Å—Ç—Ä—ã–π fallback** —á–µ—Ä–µ–∑ get_critical_facts()
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π** (info_updating)
4. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ–ø–∏–ø–∞—Å—Ç–∞** –¥–ª—è —á–∏—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
5. **–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã** (–±—ã–ª–æ ‚Üí —Å—Ç–∞–ª–æ)

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: ImportError –¥–ª—è models.Message
```python
# –†–µ—à–µ–Ω–∏–µ: –º–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ Message (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç dict)
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ
```python
# –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ get_critical_facts() –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
critical = module.get_critical_facts(dialogue_id)
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```python
# –†–µ—à–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ metadata['is_info_update']
if result.metadata.get('is_info_update'):
    # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
```

## üìù –ß–µ–∫–ª–∏—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- [ ] –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
- [ ] –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤ –≤ __init__.py
- [ ] –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Orchestrator
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ–≤
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ info_updating
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—ç—à-—Ö–∏—Ç–æ–≤

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Optimizer**
   ```python
   extraction.set_dependencies(optimizer=optimizer_module)
   ```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ TTL –¥–ª—è –∫—ç—à–∞**
   - –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ FACT_TTL –≤ module.py

3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤**
   - –†–∞—Å—à–∏—Ä—å—Ç–µ fact_patterns_extended.py

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   ```python
   stats = module.get_stats()
   print(f"Cache hits: {stats['module_stats']['cache_hits']}")
   ```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `grep "ExtractionModule" logs/`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã: `python -m pytest tests/test_extraction_module.py`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: `module.get_stats()`

---

**–í–µ—Ä—Å–∏—è**: 3.1  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 2024  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í–´–°–û–ö–ò–ô  
**–°—Ä–æ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏**: 3 –¥–Ω—è